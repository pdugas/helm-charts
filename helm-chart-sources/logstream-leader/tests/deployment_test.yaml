suite: Deployment
templates:
  - deployment.yaml
tests:
  - it: Should have health checks by default
    asserts:
      - exists:
          path: spec.template.spec.containers[0].readinessProbe
      - exists:
          path: spec.template.spec.containers[0].livenessProbe

  - it: Should disable health checks
    set:
      config.probes: false
    asserts:
      - notExists:
          path: spec.template.spec.containers[0].readinessProbe
      - notExists:
          path: spec.template.spec.containers[0].livenessProbe

  - it: Should customize health checks
    set:
      config:
        readinessProbe:
          httpGet:
            path: /isnt/a/real/endpoint
            port: 420
            scheme: HTTPS
          initialDelaySeconds: 5
          failureThreshold: 1
        livenessProbe:
          httpGet: null
          initialDelaySeconds: null
          failureThreshold: null
          foo: bar
    asserts:
      - equal:
          path: spec.template.spec.containers[0].readinessProbe
          value:
            httpGet:
              path: /isnt/a/real/endpoint
              port: 420
              scheme: HTTPS
            initialDelaySeconds: 5
            failureThreshold: 1
      - equal:
          path: spec.template.spec.containers[0].livenessProbe
          value:
            foo: bar

  - it: Should define TCP as the default protocol for a port
    set:
      service:
        ports:
          - name: foo
            port: 420
    asserts:
      - equal:
          path: spec.template.spec.containers[0].ports
          value:
            - name: foo
              containerPort: 420
              protocol: TCP

  - it: Should define UDP as the protocol for a port
    set:
      service:
        ports:
          - name: foo
            port: 420
            protocol: UDP
    asserts:
      - equal:
          path: spec.template.spec.containers[0].ports
          value:
            - name: foo
              containerPort: 420
              protocol: UDP

  - it: Should include CRIBL_K8S_POD and CRIBL_K8S_CPU_LIMIT from downward API
    asserts:
      - equal:
          path: spec.template.spec.containers[0].env[3].name
          value: CRIBL_K8S_POD
      - equal:
          path: spec.template.spec.containers[0].env[3].valueFrom.fieldRef.fieldPath
          value: metadata.name
      - equal:
          path: spec.template.spec.containers[0].env[4].name
          value: CRIBL_K8S_CPU_LIMIT
      - equal:
          path: spec.template.spec.containers[0].env[4].valueFrom.resourceFieldRef.resource
          value: limits.cpu
      - equal:
          path: spec.template.spec.containers[0].env[4].valueFrom.resourceFieldRef.divisor
          value: "1m"
